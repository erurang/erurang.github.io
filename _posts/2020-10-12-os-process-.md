---
layout: post
title:  "쓰레드와 동기화방법 쓰레드로 인한 문제점"
subtitle: "쓰레드와 동기화방법 쓰레드로 인한 문제점"
categories: cs
tags: os
comments: true

---

## 쓰레드란 무엇인가?

하나의 프로세스에 여러개의 쓰레드를 생성할수있다. (하나의 프로세스가 스택영역에서 작업을 동시 실행함)

프로세스 안에서 실행되기 때문에 프로세스 데이터를 모두 접근가능하다. (IPC를 사용하지않아도 됨)

프로세스의 구성요소중 stack영역에서 독립적으로 작동한다.

쓰레드도 CPU를 점유하는 방식이 연속적이지 않고 CPU가 프로세스 할당을 주고 뺏기 때문에 IPC와 똑같이 PC와 SP가 필요하게 된다.

쓰레드를 늘린다는것은 Context Switching이 자주 일어난다는 뜻이고, 그렇기때문에 성능이 낮아지게된다. 쓰레드의 적당한 갯수를 유지하여 사용하는것이 중요하다.

## 쓰레드간의 동기화를 생각해보자.

```
let cnt = 0

    PA   PB    PC
        1~100

        files.txt
```

3개의 프로세스가 같은 파일에 존재하는 숫자를 하나씩 가져와서 1부터 100까지 cnt에 더하는 쓰레드를 만들었다고 해보자.

각 프로세스는 1.같은 파일을 읽고 2.cnt에 더한후에 3.저장 한다고 해보자.

만약에 PA에서 1까지 파일을 더했는데, 콘텍스트스위칭이 일어났다고 하면, PB에서는 다시 1을 더하게 될것이다. 왜냐? 1에서의 저장이 일어나지 않았기때문이다.

그후에 다시 PA의 차례가 되면 저장을 한뒤 다시 2부터 더하게 된다. 우리는 쓰레드를 사용하여 성능 개선을 하려했지만 오히려 잘못된 컨텍스트 스위칭으로인해 결과값이 이상하게 되었다.

## 동기화를 관리하기위해서는..

쓰레드가 동일한 자원을 접근하는 영역을 임계영역 이라고 한다. 이 임계영역을 관리하기위한 방법이 존재한다.

1. mutex - 한 임계영역에는 하나의 쓰레드만 접근이 가능하다!
2. semaphore - 정해진 갯수만큼의 쓰레드만 접근이 가능하다!
3. Lock을 통해 임계영역의 변수를 사용못하도록 막는다!

1번의 경우엔 하나에 한 쓰레드만 접근이 가능하기떄문에 문제가 생기지 않는다.

2번의 경우 매번 프로세스가 쓰레드를 사용가능한지 요청을 하게되어. CPU의 낭비가 일어나게된다. (바쁜대기)

그래서 CPU 사용을 요청한 프로세스들을 Queue에 순서대로 넣어두어 프로세스상태를 대기상태로 바꾼후, 순서가 됫을때 큐에서 꺼내 프로세스상태를 레디로 바꾸고 처리하도록 한다.

## 데드락

두개의 프로세스가 같은 자원을 요청하지만 받지못하는 상태를 일컬어 데드락이라 한다.

PA에서 a 자원을 사용하기위해 lock을 설정후 b자원을 요청했다고 해보자. 만약 PB에서 b 자원을 사용하기위해 b를 lock시킨후 a 자원을 사용하기위해 요청을 한다면? 

PB는 a 자원을 얻지못해 무한대기 상태에 빠지게된다. 또한 PA도 b자원을 얻지못해 무한대기 상태에 빠지게된다. 이 상태를 데드락이라고 한다.

## 기아상태

우선순위가 낮아서 계속 자원을 할당받지 못하는 상태를 뜻한다.

```
[xxxxxxxxxxxxx]
[x]
```

위와같은 우선순위를 가진 프로세스가 있다고 해보자. 매번 위와같이 요청이 일어났을때 아래의 자원은 우선순위가 낮기때문에 CPU에 자원을 요청해도 할당받지못해서 언제 실행될지 모르게된다.

이 상태를 기아상태 라고한다.


<!-- 
![process1](https://user-images.githubusercontent.com/56789064/95735566-ee3a0a00-0cbf-11eb-800c-61fd299fc9c9.jpg)
![process2](https://user-images.githubusercontent.com/56789064/95735570-ef6b3700-0cbf-11eb-9069-121075cb9d18.jpg)
![process3](https://user-images.githubusercontent.com/56789064/95735571-ef6b3700-0cbf-11eb-8b4e-ea1ba87ab062.jpg)
![process4](https://user-images.githubusercontent.com/56789064/95735575-f003cd80-0cbf-11eb-9c25-60e51cd77e62.jpg)
![process5](https://user-images.githubusercontent.com/56789064/95735577-f003cd80-0cbf-11eb-8325-70983bd26eb0.jpg) -->



