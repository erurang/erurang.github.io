---
layout: post
title:  "code splitting을 위한 React lazy"
subtitle: "code splitting을 위한 React lazy"
categories: web
tags: react
comments: true

---

### React Lazy
디자인 사이트에서 유료로 산 템플릿의 리액트 코드에 아래와 같은 (예시) 코드가 있었다.

```
import { lazy, Suspense } from "react";

const LazyComponent = lazy(() => import("./components/lazy"));
const AComponent = lazy(() => import("./components/a"));

<Suspense fallback={<h1>로딩중 ...</h1>}>
    <LazyComponent />
    <AComponent />
</Suspense>
```

처음인 이게 대체 무엇이지? 생각했다. 여태 개발을 하면서 한번도 보지못한 코드였다. 

하지만 결국 나는 이 Lazy를 이용하게 되었는데, 이유는 프로젝트 빌드 이후에 내 웹사이트 초기 로딩이 너무 길었던 것이다.

## 내 웹페이지는 왜이렇게 느린걸까?

로딩이 긴 이유를 찾기위해서 난 하나하나 파고들어봐야 했다. 일단 프론트에서 로딩이 길어진다..?

서버에서 데이터를 받아오는 시간이 길다는 뜻인데.. 이것을 

1. 각 페이지의 컴포넌트에서 useEffect를 이용하여 데이터를 받아왔다.
   1. 그럼 매 컴포넌트에서 서버에서 데이터를 받아오는것이 아니라 최상단 컴포넌트에서 한번 받아오자
   2. 받아온 데이터를 컴포넌트에 맡게 뿌려주자.

위의 시도끝에 나는 각 페이지마다 api 요청을 통해 데이터를 받아오는 일은 사라졌다.

각 페이지에서 서버 요청을 통해 데이터를 받아오지않기 떄문에, 페이지를 접속후에 데이터를 받아오는 한번의 로딩시간만 줄일 생각을 하면 되었다.



근데 결과는 똑같았다. 왜냐? 데이터를 받아오는 횟수를 줄였을뿐이지, 내 페이지 로딩에는 큰 차이가없었다.

그럼 대체 무엇이 문제이고, 나는 어떻게 페이지 접속시의 로딩시간을 줄일수있는 것일까?

이런 과정을 통해 나는 lazy를 사용하는 이유를 알게되고, lazy를 적용후에 내 웹페이지 성능은 향상되었다. 

// 웹페이지 성능 측정 결과 사진

## lazy가 무슨 역할을 해주는것인가?

1. 웹페이지가 빌드가 되면, 하나의 html파일에 모든 js파일이 합쳐지게된다.
2. 빌드된 웹페이지에 우리가 접속한다.
3. html에 적힌 모든 js를 다운로드한후 실행한다.
4. 완성된 웹페이지를 우리가 이용한다.

우리가 웹페이지를 접속했을때 우리가 안쓰는 routes의 js 파일까지 받을 이유가 있을까?

나는 웹사이트를 이용하는 사용자인데, 관리자 페이지의 파일까지 받아올 이유가 없다. 이것 자체가 낭비이다.

예시로 내 웹사이트는 `home news billboard blog blogdetail admin` 총 6개의 라우터가 존재한다.

즉 나는 /home 에만 접속했을뿐인데 나머지 모든 router의 js파일들을 다 다운받아온것이다. 

이것이 내 웹페이지 로딩을 길게하는 원인이였고, 내 사이트의 성능점수가 낮은 이유였다.

모든 js파일이 아닌 그때 필요한 js만 다운로드 받는것, 이것이 lazy를 이용한 code splitting 이다.

## react에서 lazy를 사용해보자.


<!-- 
0.Overview
사용자가 웹 페이지를 열면 전체 페이지의 내용이 다운로드 되어 단일 이동으로 렌더링이 됩니다.
이를 통해 브라우저는 웹페이지를 캐시할 수 있지만 사용자가 다운로드한 모든 콘텐츠를 실제로 볼 수 있다는 보장은 없습니다.
예를 들어 전체 사진 갤러리를 다운로드했지만 사용자가 첫번째 이미지만 본 후 사용자가 떠났을 때 웹페이지에서는 메모리 및 대역폭 낭비로 인해 발생합니다.
페이지에 액세스할 때 모든 콘텐츠를 대량으로 로드하는 대신 사용자가 필요한 페이지의 일부에 액세스할 때 콘텐츠를 로드할 수 있습니다.
lazy loading을 사용하면 페이지가 placeholder 콘텐츠로 작성되며, 사용자가 필요할 때만 실제 콘텐츠로 대체 됩니다.
1. 무엇이며 어떻게 적용이 되는가?
lazy loading은 페이지를 읽어들이는 시점에 중요하지 않은 리소스 로딩을 추 후에 하는 기술 입니다. 대신에 이 중요하지 않은 리소스들은 필요할 때 로드가 되어야 합니다.
이미지와 관련된 경우에는 중요하지 않은 리소스들은 "off-screen"와 함께 동기화가 됩니다.
누군가가 웹페이지(이미지, 비디오 등)에 리소스를 추가할 때, 리소스는 small placeholder를 참조합니다. 사용자가 웹페이지를 검색할 때 실제 리소스는 브라우저에 의해 캐시되고 리소스가 사용자 화면에 표시될 때 placeholder를 대체합니다.
예를 들어, 사용자가 웹페이지를 로드하고 즉시 남겨 두면 웹페이지의 맨 위 부분 이외의 항목이 로드되지 않습니다.
이미지, 비디오를 그냥 로딩하지 않고 lazy loading을 사용하는 이유는 사용자가 볼 수 없는 것들을 로딩할 가능성이 있기 때문입니다.
- 사용자가 보고 있지 않은 것들을 로딩할 때 데이터가 낭비됩니다. 무제한 요금제를 사용하는 사용자인 경우에는 상관이 없지만 제한된 요금제를 사용하는 사용자인 경우 사용자가 보고 있지 않은 화면을 로딩하는 것은 자원(돈)을 낭비할 수도 있습니다.
- 미디어 리소스를 다운로드 한 후 브라우저는 이를 디코딩하여 화면에 렌더링 해야 합니다.
2. SEO에 미치는 영향
lazy loading은 검색 엔진 순위에 영향을 미친다. 리소스는 placeholder 콘텐츠여서 웹사이트를 크롤링하는 검색 엔진은 리소스의 내용을 잘못 해석하거나 무시할 수 있습니다.
블로그 게시물과 같은 웹페이지의 전체 구성 요소를 느리게 로드하면 검색 엔진이 해당 구성 요소를 우회하여 콘텐츠가 인덱싱 되지 않아 검색 엔진 결과가 줄어들 수 있습니다.
이러한 문제를 극복하는 한 가지 요령은 lazy load하는 콘텐츠에 대한 링크를 제공하는 것입니다.
이렇게 하면 기본적으로 검색 엔진 크롤러가 액세스 할 수 있는 콘텐츠에서 웹페이지를 만듭니다.
검색 엔진이 웹사이트를 index하면 이러한 링크를 따라가며 검색한 내용을 색인화 합니다.
이 방법은 기본적으로 사용자가 콘텐츠를 동적으로 로드할 수 있게 하면서 lazy load도 웹사이트를 전통적인 웹사이트로 구성합니다.
3. 예시
워드프레스는 infinite scroll이라 불리는 lazy loading솔루션을 제공합니다.
infinite scroll은 사용자가 페이지로 스크롤할 때 지속적으로 로드 합니다.
무한히 로드하는 웹페이지에서 일반적으로 액세스 할 수 없는 footer는 스크롤 하는 내용 아래에 오버레이로 표시 됩니다.
wordpress는 전통적인 페이지 기반 접근 방식과 달리 infinite scroll을 사용할 때 사용자가 더 많은 게시물을 읽습니다.
구글은 이미지 검색 결과에 대해 다른 접근 방식을 취합니다.
사용자가 페이지를 스크롤할 때 placeholder 이미지가 썸네일로 바뀝니다.
특정 수의 이미지가 표시 된 후 button을 누르면 추가 이미지를 로드할 수 있습니다.
button을 사용하여 Google은 무한 스크롤링과 lazy loading을 결합하여 동적 하이브리드 접근법을 만듭니다.
4. 장점
1) lazy loading은 콘텐츠 전달 최적화와 최종 사용자 간의 경험을 간소화 하는 균형을 맞춥니다.
2) 사용자가 처음 열 때 웹 사이트의 일부만 다운로드 해야하므로 사용자에게 콘텐츠를 더 빨리 제공합니다.
3) 콘텐츠가 지속적으로 사용자에게 공급되므로 사용자가 웹사이트를 이탈할 확률을 낮출 수 있습니다.
4) 사용자가 한 번에 필요로 하는 경우에만 콘텐츠를 불러오므로 리소스 비용(사용자의 배터리, 시간, 시스템 리소스)이 낮아진다. -->